package jp.gr.java_conf.daisy.ajax_mutator.mutation_viewer;

import java.util.ArrayList;
import java.util.List;

/**
 * Parse unified diff (generated by our tool) and extract necessary information for mutation viewer.
 */
class UnifiedDiffParser {
    public class Mutation {
        private final String fileName;
        private final int startLine;
        private final List<String> originalLines;
        private final List<String> mutatedLines;

        public Mutation(String fileName, int startLine, List<String> originalLines, List<String> mutatedLines) {
            this.fileName = fileName;
            this.startLine = startLine;
            this.originalLines = originalLines;
            this.mutatedLines = mutatedLines;
        }

        public String getFileName() {
            return fileName;
        }

        public int getStartLine() {
            return startLine;
        }

        public String getLines() {
            if (originalLines.size() == 1) {
                return Integer.toString(startLine);
            } else {
                return startLine + "-" + (startLine + originalLines.size() - 1);
            }
        }

        public List<String> getOriginalLines() {
            return originalLines;
        }

        public List<String> getMutatedLines() {
            return mutatedLines;
        }
    }

    public Mutation parse(List<String> unifiedDiffContent) {
        String headerForOriginalFile = unifiedDiffContent.get(0);
        String[] lineInfo = unifiedDiffContent.get(2).replace("@@ -", "").trim().split("\\s")[0].split(",");
        int numOriginalContentLines  = lineInfo.length == 1 ? 1 : Integer.parseInt(lineInfo[1]);
        List<String> originalLines = new ArrayList<String>();
        for (int i = 0; i < numOriginalContentLines; i++) {
            originalLines.add(unifiedDiffContent.get(3 + i).substring(1));
        }
        List<String> mutatedLines = new ArrayList<String>();
        for (int i = 3 + numOriginalContentLines; i < unifiedDiffContent.size(); i++) {
            mutatedLines.add(unifiedDiffContent.get(i).substring(1));
        }
        return new Mutation(
                headerForOriginalFile.replace("---", "").trim().split("\\s")[0],
                Integer.parseInt(lineInfo[0]),
                originalLines,
                mutatedLines
        );
    }
}
